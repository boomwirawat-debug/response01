<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมทดสอบขบวนรถไฟ (ฉบับสมบูรณ์)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Styles --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        #app-container {
            width: 100%;
            max-width: 600px;
        }
        
        /* --- หน้าจอต่างๆ --- */
        #menu-container, #game-container, #part-score-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
            box-sizing: border-box;
            display: none; /* ซ่อนโดย Default */
        }
        
        h1, h2 { color: #1a3a66; margin-bottom: 20px; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.6rem; margin-top: 0; }

        /* --- เมนูเลือกพาส --- */
        #part-selection-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* --- ส่วนของเกม --- */
        #score-counter {
            font-size: 1rem;
            color: #555;
            margin-bottom: 20px;
            font-weight: 600;
        }

        #question-container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            min-height: 60px;
            text-align: left;
        }
        
        .question-line {
            font-size: 1.15rem;
            font-weight: 600;
            line-height: 1.5;
            color: #333;
        }
        .question-line span { font-weight: bold; color: #0056b3; }
        
        #answer-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .answer-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        .answer-group label {
            font-size: 1rem;
            font-weight: 600;
            color: #d9534f;
            margin-bottom: 5px;
        }

        .answer-input {
            font-family: 'Sarabun', sans-serif;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .answer-input:focus { border-color: #007bff; outline: none; }
        .answer-input.correct { border-color: #28a745; background-color: #f0fff4; color: #28a745; }
        .answer-input.incorrect { border-color: #dc3545; background-color: #fff0f0; color: #dc3545; }

        #feedback {
            font-size: 1.15rem;
            font-weight: bold;
            margin-top: 15px;
            min-height: 30px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* --- ปุ่มควบคุม --- */
        #action-button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            font-family: 'Sarabun', sans-serif;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-grow: 1;
            min-width: 120px;
            box-sizing: border-box;
        }
        
        .part-button { background-color: #007bff; width: 100%; }
        .part-button:hover { background-color: #0056b3; }

        #submit-button { background-color: #007bff; }
        #submit-button:hover { background-color: #0056b3; }
        #hint-button { background-color: #f0ad4e; }
        #hint-button:hover { background-color: #ec971f; }
        #navigation-button { background-color: #6c757d; }
        #navigation-button:hover { background-color: #5a6268; }
        
        #back-to-menu-button { background-color: #6c757d; width: 100%; margin-bottom: 10px;}
        #review-button { background-color: #17a2b8; width: 100%; margin-bottom: 10px; display: none;}
        #export-pdf-button { background-color: #28a745; width: 100%; margin-bottom: 10px;} /* ปุ่ม PDF สีเขียว */

        /* --- ส่วนรีวิว --- */
        #review-container {
            margin-top: 20px;
            text-align: left;
            border-top: 2px solid #eee;
            padding-top: 15px;
            display: none;
        }
        .review-item {
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .review-wrong { color: #dc3545; font-weight: bold; }
        .review-correct { color: #28a745; font-weight: bold; }

        /* --- (ใหม่) ส่วนสำหรับพิมพ์ (Print Area) --- */
        #print-container {
            display: none; /* ซ่อนในหน้าจอปกติ */
            font-family: 'Sarabun', sans-serif;
            padding: 20px;
            background: white;
        }
        
        /* Table สำหรับรายงาน */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .report-table th, .report-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .status-correct { color: green; font-weight: bold; }
        .status-wrong { color: red; font-weight: bold; }

        /* --- Media Query สำหรับการพิมพ์ --- */
        @media print {
            body { background-color: white; display: block; padding: 0; }
            #app-container { display: none !important; } /* ซ่อนแอปปกติ */
            #print-container { display: block !important; } /* แสดงส่วนรายงาน */
            @page { margin: 2cm; }
        }

        @media (max-width: 480px) {
            h1, h2 { font-size: 1.6rem; }
            .action-btn { font-size: 0.9rem; width: 100%; flex-grow: 0; }
            #action-button-container { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- คอนเทนเนอร์หลักของแอป -->
    <div id="app-container">
        <!-- หน้าเมนู -->
        <div id="menu-container">
            <h1>เลือกชุดข้อสอบ</h1>
            <p style="color: #666; margin-bottom: 20px;">(ขอให้ทุกท่านโชคดีกับการทำข้อสอบครับ)</p>
            <div id="part-selection-container"></div>
        </div>

        <!-- หน้าเกม -->
        <div id="game-container">
            <h1>เกมทดสอบขบวนรถไฟ</h1>
            <div id="score-counter">กำลังโหลด...</div>
            <div id="question-container"></div>
            <div id="answer-container"></div>
            <div id="feedback"></div>
            <div id="action-button-container">
                <button id="submit-button" class="action-btn">ส่งคำตอบ</button>
                <button id="hint-button" class="action-btn">ขอดูเฉลย</button>
                <button id="navigation-button" class="action-btn">ข้าม</button>
            </div>
        </div>
        
        <!-- หน้าสรุปคะแนน -->
        <div id="part-score-container">
            <h2>สรุปคะแนน (ชุดนี้)</h2>
            <div id="part-score-display" style="font-size: 1.5rem; font-weight: bold; color: #28a745; margin-bottom: 20px;">
                คุณทำได้ 0 / 0 คะแนน
            </div>
            
            <!-- ปุ่มต่างๆ -->
            <button id="export-pdf-button" class="action-btn">บันทึกเป็น PDF (พิมพ์รายงาน)</button>
            <button id="review-button" class="action-btn">ดูข้อที่ผิดในหน้าจอนี้</button>
            <button id="back-to-menu-button" class="action-btn">กลับไปหน้าหลัก</button>
            
            <div id="review-container"></div>
        </div>
    </div> 

    <!-- (ใหม่) ส่วนสำหรับพิมพ์รายงาน (จะแสดงเฉพาะตอนสั่งพิมพ์) -->
    <div id="print-container">
        <h2 id="print-title" style="text-align: center;">รายงานผลการทดสอบ</h2>
        <p id="print-score" style="text-align: center; font-size: 1.2rem;"></p>
        <div id="print-content"></div>
        <p style="text-align: center; margin-top: 30px; font-size: 0.8rem; color: #555;">สร้างโดย: เกมทดสอบขบวนรถไฟ</p>
    </div>

    <!-- --- JavaScript --- -->
    <script>
        // --- ข้อมูลรถไฟทั้งหมด ---
        const trainData = [
            { route: "กรุงเทพอภิวัฒน์ - ชุมทางหาดใหญ่", number: "31 CNR", type: "ด่วนพิเศษ" },
            { route: "ชุมทางหาดใหญ่ - กรุงเทพอภิวัฒน์", number: "32 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - สุไหงโก-ลก", number: "37", type: "ด่วนพิเศษ" },
            { route: "สุไหงโก-ลก - กรุงเทพอภิวัฒน์", number: "38", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - สุราษฎร์ธานี", number: "39", type: "ด่วนพิเศษ" },
            { route: "สุราษฎร์ธานี - กรุงเทพอภิวัฒน์", number: "40", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - สุราษฎร์ธานี", number: "43", type: "ด่วนพิเศษ" },
            { route: "สุราษฎร์ธานี - กรุงเทพอภิวัฒน์", number: "44", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - ปาดังเบซาร์", number: "45", type: "ด่วนพิเศษ" },
            { route: "ปาดังเบซาร์ - กรุงเทพอภิวัฒน์", number: "46", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - ตรัง", number: "83", type: "ด่วน" },
            { route: "ตรัง - กรุงเทพอภิวัฒน์", number: "84", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - นครศรีธรรมราช", number: "85", type: "ด่วน" },
            { route: "นครศรีธรรมราช - กรุงเทพอภิวัฒน์", number: "86", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - กันตัง", number: "167", type: "เร็ว" },
            { route: "กันตัง - กรุงเทพอภิวัฒน์", number: "168", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - ยะลา", number: "169", type: "เร็ว" },
            { route: "ยะลา - กรุงเทพอภิวัฒน์", number: "170", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - สุไหงโก-ลก", number: "171", type: "เร็ว" },
            { route: "สุไหงโก-ลก - กรุงเทพอภิวัฒน์", number: "172", type: "เร็ว" },
            { route: "ธนบุรี - ประจวบคีรีขันธ์", number: "251", type: "ธรรมดา" },
            { route: "ประจวบคีรีขันธ์ - ธนบุรี", number: "252", type: "ธรรมดา" },
            { route: "ธนบุรี - หลังสวน", number: "255", type: "ธรรมดา" },
            { route: "หลังสวน - ธนบุรี", number: "254", type: "ธรรมดา" },
            { route: "ธนบุรี - น้ำตก", number: "257", type: "ธรรมดา" },
            { route: "น้ำตก - ธนบุรี", number: "258", type: "ธรรมดา" },
            { route: "ธนบุรี - น้ำตก", number: "259", type: "ธรรมดา" },
            { route: "น้ำตก - ธนบุรี", number: "260", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - สวนสนประดิพัทธ์", number: "261", type: "ธรรมดา" },
            { route: "สวนสนประดิพัทธ์ - กรุงเทพ (หัวลำโพง)", number: "262", type: "ธรรมดา" },
            { route: "ธนบุรี - ราชบุรี", number: "351", type: "ชานเมือง" },
            { route: "ราชบุรี - ธนบุรี", number: "352", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - บ้านโป่ง", number: "355", type: "ชานเมือง" },
            { route: "บ้านโป่ง - กรุงเทพ (หัวลำโพง)", number: "356", type: "ชานเมือง" },
            { route: "ชุมพร - ชุมทางหาดใหญ่", number: "445", type: "ท้องถิ่น" },
            { route: "ชุมทางหาดใหญ่ - ชุมพร", number: "446", type: "ท้องถิ่น" },
            { route: "สุราษฎร์ธานี - สุไหงโก-ลก", number: "447", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - สุราษฎร์ธานี", number: "448", type: "ท้องถิ่น" },
            { route: "นครศรีธรรมราช - สุไหงโก-ลก", number: "451", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - นครศรีธรรมราช", number: "452", type: "ท้องถิ่น" },
            { route: "ยะลา - สุไหงโก-ลก", number: "453", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - ยะลา", number: "454", type: "ท้องถิ่น" },
            { route: "นครศรีธรรมราช - ยะลา", number: "455", type: "ท้องถิ่น" },
            { route: "ยะลา - นครศรีธรรมราช", number: "456", type: "ท้องถิ่น" },
            { route: "พัทลุง - สุไหงโก-ลก", number: "463", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - พัทลุง", number: "464", type: "ท้องถิ่น" },
            { route: "กาญจนบุรี - น้ำตก", number: "485", type: "ท้องถิ่น" },
            { route: "น้ำตก - กาญจนบุรี", number: "486", type: "ท้องถิ่น" },
            { route: "สุราษฎร์ธานี - คีรีรัฐนิคม", number: "489", type: "ท้องถิ่น" },
            { route: "คีรีรัฐนิคม - สุราษฎร์ธานี", number: "490", type: "ท้องถิ่น" },
            { route: "ชุมทางหาดใหญ่ - ปาดังเบซาร์", number: "947", type: "พิเศษโดยสาร" },
            { route: "ปาดังเบซาร์ - ชุมทางหาดใหญ่", number: "948", type: "พิเศษโดยสาร" },
            { route: "ชุมทางหาดใหญ่ - ปาดังเบซาร์", number: "949", type: "พิเศษโดยสาร" },
            { route: "ปาดังเบซาร์ - ชุมทางหาดใหญ่", number: "950", type: "พิเศษโดยสาร" },
            { route: "ธนบุรี - นครปฐม", number: "1115", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1116", type: "พิเศษชานเมือง" },
            { route: "ธนบุรี - นครปฐม", number: "1117", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1118", type: "พิเศษชานเมือง" },
            { route: "ธนบุรี - นครปฐม", number: "1123", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1124", type: "พิเศษชานเมือง" },
            { route: "ธนบุรี - นครปฐม", number: "1129", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1132", type: "พิเศษชานเมือง" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "7", type: "ด่วนพิเศษ" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "8", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "9 CNR", type: "ด่วนพิเศษ" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "10 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "13", type: "ด่วนพิเศษ" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "14", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "51", type: "ด่วน" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "52", type: "ด่วน" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "102", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - เด่นชัย", number: "107", type: "เร็ว" },
            { route: "เด่นชัย - กรุงเทพอภิวัฒน์", number: "108", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "109", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - เด่นชัย", number: "111", type: "เร็ว" },
            { route: "เด่นชัย - กรุงเทพอภิวัฒน์", number: "112", type: "เร็ว" },
            { route: "กรุงเทพ (หัวลำโพง) - พิษณุโลก", number: "201", type: "ธรรมดา" },
            { route: "พิษณุโลก - กรุงเทพ (หัวลำโพง)", number: "202", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - นครสวรรค์", number: "207", type: "ธรรมดา" },
            { route: "นครสวรรค์ - กรุงเทพ (หัวลำโพง)", number: "208", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - บ้านตาคลี", number: "209", type: "ธรรมดา" },
            { route: "บ้านตาคลี - กรุงเทพ (หัวลำโพง)", number: "210", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ตะพานหิน", number: "211", type: "ธรรมดา" },
            { route: "ตะพานหิน - กรุงเทพ (หัวลำโพง)", number: "212", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ลพบุรี", number: "301", type: "ชานเมือง" },
            { route: "ลพบุรี - กรุงเทพ (หัวลำโพง)", number: "302", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ลพบุรี", number: "303", type: "ชานเมือง" },
            { route: "ลพบุรี - กรุงเทพ (หัวลำโพง)", number: "304", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางบ้านภาชี", number: "313", type: "ชานเมือง" },
            { route: "ชุมทางบ้านภาชี - กรุงเทพ (หัวลำโพง)", number: "314", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ลพบุรี", number: "317", type: "ชานเมือง" },
            { route: "ลพบุรี - กรุงเทพ (หัวลำโพง)", number: "318", type: "ชานเมือง" },
            { route: "ลพบุรี - พิษณุโลก", number: "401", type: "ท้องถิ่น" },
            { route: "พิษณุโลก - ลพบุรี", number: "402", type: "ท้องถิ่น" },
            { route: "พิษณุโลก - ศิลาอาสน์", number: "403", type: "ท้องถิ่น" },
            { route: "นครสวรรค์ - เชียงใหม่", number: "407", type: "ท้องถิ่น" },
            { route: "เชียงใหม่ - นครสวรรค์", number: "408", type: "ท้องถิ่น" },
            { route: "ศิลาอาสน์ - พิษณุโลก", number: "410", type: "ท้องถิ่น" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "21", type: "ด่วนพิเศษ" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "22", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "23 CNR", type: "ด่วนพิเศษ" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "24 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - หนองคาย", number: "25 CNR", type: "ด่วนพิเศษ" },
            { route: "หนองคาย - กรุงเทพอภิวัฒน์", number: "26 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "71", type: "ด่วน" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "72", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - หนองคาย", number: "75", type: "ด่วน" },
            { route: "หนองคาย - กรุงเทพอภิวัฒน์", number: "76", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - เวียงจันทน์ (คำสะหวาด)", number: "133", type: "เร็ว" },
            { route: "เวียงจันทน์ (คำสะหวาด) - กรุงเทพอภิวัฒน์", number: "134", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "135", type: "เร็ว" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "136", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "139", type: "เร็ว" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "140", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "141", type: "เร็ว" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "142", type: "เร็ว" },
            { route: "หนองคาย - เวียงจันทน์ (คำสะหวาด)", number: "147", type: "เร็ว" },
            { route: "เวียงจันทน์ (คำสะหวาด) - หนองคาย", number: "148", type: "เร็ว" },
            { route: "กรุงเทพ (หัวลำโพง) - สุรินทร์", number: "233", type: "ธรรมดา" },
            { route: "สุรินทร์ - กรุงเทพ (หัวลำโพง)", number: "234", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางแก่งคอย", number: "339", type: "ชานเมือง" },
            { route: "ชุมทางแก่งคอย - กรุงเทพ (หัวลำโพง)", number: "340", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางแก่งคอย", number: "341", type: "ชานเมือง" },
            { route: "ชุมทางแก่งคอย - กรุงเทพ (หัวลำโพง)", number: "342", type: "ชานเมือง" },
            { route: "นครราชสีมา - หนองคาย", number: "415", type: "ท้องถิ่น" },
            { route: "อุดรธานี - นครราชสีมา", number: "416", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุดรธานี", number: "417", type: "ท้องถิ่น" },
            { route: "หนองคาย - นครราชสีมา", number: "418", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุบลราชธานี", number: "419", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - ลำชี", number: "420", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุบลราชธานี", number: "421", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - ลำชี", number: "422", type: "ท้องถิ่น" },
            { route: "ลำชี - สำโรงทาบ", number: "423", type: "ท้องถิ่น" },
            { route: "สำโรงทาบ - นครราชสีมา", number: "424", type: "ท้องถิ่น" },
            { route: "ลำชี - อุบลราชธานี", number: "425", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - นครราชสีมา", number: "426", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุบลราชธานี", number: "427", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - นครราชสีมา", number: "428", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - ชุมทางบัวใหญ่", number: "429", type: "ท้องถิ่น" },
            { route: "ชุมทางบัวใหญ่ - นครราชสีมา", number: "430", type: "ท้องถิ่น" },
            { route: "ชุมทางแก่งคอย - ขอนแก่น", number: "431", type: "ท้องถิ่น" },
            { route: "ขอนแก่น - ชุมทางแก่งคอย", number: "432", type: "ท้องถิ่น" },
            { route: "ชุมทางแก่งคอย - ชุมทางบัวใหญ่", number: "433", type: "ท้องถิ่น" },
            { route: "ชุมทางบัวใหญ่ - ชุมทางแก่งคอย", number: "434", type: "ท้องถิ่น" },
            { route: "ชุมทางแก่งคอย - ชุมทางบัวใหญ่", number: "439", type: "ท้องถิ่น" },
            { route: "ชุมทางบัวใหญ่ - ชุมทางแก่งคอย", number: "440", type: "ท้องถิ่น" },
            { route: "กรุงเทพ (หัวลำโพง) - ด่านพรมแดนบ้านคลองลึก", number: "275", type: "ธรรมดา" },
            { route: "ด่านพรมแดนบ้านคลองลึก - กรุงเทพ (หัวลำโพง)", number: "276", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - กบินทร์บุรี", number: "277", type: "ธรรมดา" },
            { route: "กบินทร์บุรี - กรุงเทพ (หัวลำโพง)", number: "278", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ด่านพรมแดนบ้านคลองลึก", number: "279", type: "ธรรมดา" },
            { route: "ด่านพรมแดนบ้านคลองลึก - กรุงเทพ (หัวลำโพง)", number: "280", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - กบินทร์บุรี", number: "281", type: "ธรรมดา" },
            { route: "กบินทร์บุรี - กรุงเทพ (หัวลำโพง)", number: "282", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - จุกเสม็ด", number: "283", type: "ธรรมดา" },
            { route: "จุกเสม็ด - กรุงเทพ (หัวลำโพง)", number: "284", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "367", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "368", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ปราจีนบุรี", number: "371", type: "ชานเมือง" },
            { route: "ปราจีนบุรี - กรุงเทพ (หัวลำโพง)", number: "372", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "379", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "380", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "383", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "384", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "388", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "389", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "390", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "391", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4302", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4303", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4304", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4305", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4306", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4307", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4308", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4309", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4310", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4311", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4312", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4313", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4314", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4315", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4316", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4317", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4320", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4321", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4322", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4323", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4324", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4325", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4326", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4327", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4328", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4329", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4340", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4341", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4342", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4343", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4344", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4345", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4346", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4347", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4380", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4381", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4382", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4383", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4384", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4385", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4386", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4387", type: "ชานเมือง" }
        ];

        // --- ตรรกะของเกม ---
        const QUESTIONS_PER_PART = 25;
        let currentPartQuestions = [];
        let allQuestionsShuffled = [];
        let currentQuestionIndex = 0;
        let currentTemplate = 0; 
        let score = 0;
        let answered = false;
        let answersLog = [];
        let currentPartIndexForPrint = 0; 

        // Element Reference (ประกาศตัวแปร)
        let menuContainer, gameContainer, partScoreContainer, partSelectionContainer,
            partScoreDisplay, backToMenuButton, reviewButton, reviewContainer,
            questionContainer, answerContainer, feedbackEl, scoreCounterEl,
            submitButton, hintButton, navButton, exportPdfButton;
            
        let appInitialized = false; 

        // Function สลับหน้าจอ
        function showView(viewName) {
            if (!menuContainer) return;
            menuContainer.style.display = 'none';
            gameContainer.style.display = 'none';
            partScoreContainer.style.display = 'none';

            if (viewName === 'menu') menuContainer.style.display = 'block';
            else if (viewName === 'game') gameContainer.style.display = 'block';
            else if (viewName === 'score') partScoreContainer.style.display = 'block';
        }

        // Utility Functions
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function normalizeText(str) { return (str || '').trim().toUpperCase().replace(/\s/g, '').replace(/\(.*\)/g, ''); }
        function normalizeNumber(str) { return (str || '').trim().toUpperCase().replace(/\s/g, ''); }
        function createInput(id, label) { return `<div class="answer-group"><label for="input-${id}">${label}:</label><input type="text" id="input-${id}" class="answer-input" placeholder="เติมคำตอบ..."></div>`; }
        function createQuestionLine(label, value) { return `<div class="question-line">${label}: <span>${value}</span></div>`; }

        // อัปเดต UI
        function updateCounters() {
            const remaining = currentPartQuestions.filter(q => q.status === 'unanswered').length;
            const totalInPart = currentPartQuestions.length;
            scoreCounterEl.textContent = `ข้อที่: ${currentQuestionIndex + 1}/${totalInPart} | คะแนน: ${score} | เหลือ: ${remaining}`;
        }

        // แสดงคำถาม
        function displayQuestion() {
            answered = false;
            currentTemplate = Math.floor(Math.random() * 3); 
            const q = currentPartQuestions[currentQuestionIndex];
            
            questionContainer.innerHTML = '';
            answerContainer.innerHTML = '';
            feedbackEl.textContent = '';
            
            switch (currentTemplate) {
                case 0: questionContainer.innerHTML = createQuestionLine('เส้นทาง', q.route) + createQuestionLine('ประเภท', q.type); answerContainer.innerHTML = createInput('number', 'หมายเลขขบวนคือ'); break;
                case 1: questionContainer.innerHTML = createQuestionLine('หมายเลข', q.number) + createQuestionLine('เส้นทาง', q.route); answerContainer.innerHTML = createInput('type', 'ประเภทรถคือ'); break;
                case 2: questionContainer.innerHTML = createQuestionLine('หมายเลข', q.number) + createQuestionLine('ประเภท', q.type); answerContainer.innerHTML = createInput('route', 'เส้นทางคือ (ต้นทาง - ปลายทาง)'); break;
            }

            submitButton.style.display = 'inline-block';
            hintButton.style.display = 'inline-block';
            navButton.style.display = 'inline-block';
            navButton.textContent = 'ข้าม';
            
            updateCounters();
            document.querySelectorAll('.answer-input').forEach(input => {
                input.onkeyup = function(event) { if (event.key === 'Enter' && !answered) checkAnswer(); };
            });
        }
        
        // (ใหม่) ฟังก์ชันบันทึกคำตอบลง Log
        function logAnswer(q, template, userAnsObj, correctAnsArr, isCorrect, isSkipped) {
            let questionText = "";
            let correctText = correctAnsArr.join(" / ");
            let userText = "";

            // สร้างข้อความโจทย์
            if (template === 0) questionText = `เส้นทาง: ${q.route}, ประเภท: ${q.type}`;
            else if (template === 1) questionText = `หมายเลข: ${q.number}, เส้นทาง: ${q.route}`;
            else if (template === 2) questionText = `หมายเลข: ${q.number}, ประเภท: ${q.type}`;

            // ดึงคำตอบผู้ใช้
            if (isSkipped) userText = "(ดูเฉลย)";
            else {
                if (template === 0) userText = userAnsObj.number;
                else if (template === 1) userText = userAnsObj.type;
                else if (template === 2) userText = userAnsObj.route;
            }
            if (!userText) userText = "(ว่าง)";

            answersLog.push({
                no: currentQuestionIndex + 1,
                question: questionText,
                userAnswer: userText,
                correctAnswer: correctText,
                isCorrect: isCorrect
            });
        }

        // ตรวจคำตอบ
        function checkAnswer() {
            if (answered) return;
            const q = currentPartQuestions[currentQuestionIndex];
            let isFullyCorrect = true; 
            let correctAnswersForHint = []; 
            let userAnswers = {}; 

            if (currentTemplate === 0) { 
                const val = document.getElementById('input-number').value; userAnswers.number = val;
                const userInputNorm = normalizeNumber(val); 
                const allMatches = trainData.filter(item => normalizeText(item.route) === normalizeText(q.route) && normalizeText(item.type) === normalizeText(q.type));
                correctAnswersForHint = allMatches.map(item => item.number); 
                const acceptableNumbersNorm = [...new Set(correctAnswersForHint.flatMap(n => [normalizeNumber(n), normalizeNumber(n.replace('CNR', ''))]))];
                
                if (acceptableNumbersNorm.includes(userInputNorm) && userInputNorm !== "") document.getElementById('input-number').classList.add('correct');
                else { document.getElementById('input-number').classList.add('incorrect'); isFullyCorrect = false; }
                document.getElementById('input-number').disabled = true;

            } else if (currentTemplate === 1) { 
                const val = document.getElementById('input-type').value; userAnswers.type = val;
                const userInputNorm = normalizeText(val); 
                correctAnswersForHint.push(q.type); 
                if (userInputNorm === normalizeText(q.type) && userInputNorm !== "") document.getElementById('input-type').classList.add('correct');
                else { document.getElementById('input-type').classList.add('incorrect'); isFullyCorrect = false; }
                document.getElementById('input-type').disabled = true;

            } else if (currentTemplate === 2) { 
                const val = document.getElementById('input-route').value; userAnswers.route = val;
                const userInputNorm = normalizeText(val); 
                correctAnswersForHint.push(q.route); 
                if (userInputNorm === normalizeText(q.route) && userInputNorm !== "") document.getElementById('input-route').classList.add('correct');
                else { document.getElementById('input-route').classList.add('incorrect'); isFullyCorrect = false; }
                document.getElementById('input-route').disabled = true;
            }

            answered = true;
            submitButton.style.display = 'none';
            hintButton.style.display = 'none';
            navButton.textContent = 'ข้อถัดไป';

            // (ใหม่) บันทึกผล
            logAnswer(q, currentTemplate, userAnswers, correctAnswersForHint, isFullyCorrect, false);

            if (isFullyCorrect) {
                feedbackEl.textContent = 'ถูกต้อง!'; feedbackEl.style.color = '#28a745';
                if (currentPartQuestions[currentQuestionIndex].status === 'unanswered') score++;
                currentPartQuestions[currentQuestionIndex].status = 'correct';
            } else {
                feedbackEl.textContent = `ผิด! คำตอบคือ: ${correctAnswersForHint.join(' / ')}`; feedbackEl.style.color = '#dc3545';
                currentPartQuestions[currentQuestionIndex].status = 'incorrect';
                // showAnswerInputFill(correctAnswersForHint); // <--- REMOVED THIS LINE
            }
            updateCounters();
        }
        
        // ดูเฉลย (กดปุ่ม)
        function showAnswer(onlyIncorrect = false, correctAnswers = []) {
            if (answered && !onlyIncorrect) return;
            const q = currentPartQuestions[currentQuestionIndex];
            
            if (correctAnswers.length === 0) {
                 if (currentTemplate === 0) {
                    const allMatches = trainData.filter(item => normalizeText(item.route) === normalizeText(q.route) && normalizeText(item.type) === normalizeText(q.type));
                    correctAnswers = allMatches.map(item => item.number);
                 } else if (currentTemplate === 1) correctAnswers = [q.type];
                 else if (currentTemplate === 2) correctAnswers = [q.route];
            }
            
            showAnswerInputFill(correctAnswers); // เติมช่อง
            
            if (!onlyIncorrect) { // กดดูเฉลยเอง
                answered = true;
                feedbackEl.textContent = `เฉลยคือ: ${correctAnswers.join(' / ')}`;
                feedbackEl.style.color = '#f0ad4e';
                currentPartQuestions[currentQuestionIndex].status = 'incorrect';
                
                // (ใหม่) บันทึกผลว่าดูเฉลย
                logAnswer(q, currentTemplate, {}, correctAnswers, false, true);

                submitButton.style.display = 'none';
                hintButton.style.display = 'none';
                navButton.textContent = 'ข้อถัดไป';
                updateCounters();
            }
        }

        function showAnswerInputFill(answers) {
            const txt = answers.join(' / ');
            if (currentTemplate === 0) { 
                const el = document.getElementById('input-number');
                if(el) { el.value = txt; el.disabled = true; }
            } else if (currentTemplate === 1) { 
                const el = document.getElementById('input-type');
                if(el) { el.value = txt; el.disabled = true; }
            } else if (currentTemplate === 2) { 
                const el = document.getElementById('input-route');
                if(el) { el.value = txt; el.disabled = true; }
            }
        }
        
        // จบพาส
        function showPartScore() {
            showView('score');
            partScoreDisplay.textContent = `คุณทำได้ ${score} / ${currentPartQuestions.length} คะแนน`;
            
            // เช็คปุ่มรีวิว (กรองเฉพาะข้อผิดจาก Log)
            const wrongAnswers = answersLog.filter(log => !log.isCorrect);
            if (wrongAnswers.length > 0) reviewButton.style.display = 'inline-block';
            else reviewButton.style.display = 'none';
            
            reviewContainer.innerHTML = '';
            reviewContainer.style.display = 'none';
        }

        // ปุ่มนำทาง
        function navigate() {
            let nextIndex = -1;
            for (let i = currentQuestionIndex + 1; i < currentPartQuestions.length; i++) {
                if (currentPartQuestions[i].status === 'unanswered') { nextIndex = i; break; }
            }
            if (nextIndex === -1) {
                for (let i = 0; i < currentQuestionIndex; i++) {
                    if (currentPartQuestions[i].status === 'unanswered') { nextIndex = i; break; }
                }
            }
            
            if (nextIndex !== -1) {
                currentQuestionIndex = nextIndex;
                displayQuestion();
            } else {
                if (currentPartQuestions[currentQuestionIndex].status === 'unanswered') {
                    // รอ
                } else {
                    showPartScore();
                }
            }
        }
        
        // เริ่มเกม
        function startGame(start, end, partNum) {
            showView('game');
            const partData = allQuestionsShuffled.slice(start, end);
            currentPartQuestions = [...partData];
            currentPartQuestions.forEach(q => q.status = 'unanswered');
            
            currentQuestionIndex = 0;
            score = 0;
            answersLog = []; // รีเซ็ต Log
            currentPartIndexForPrint = partNum; // จำชุดที่
            
            displayQuestion();
        }

        // (ใหม่) ฟังก์ชัน Export PDF (Print)
        function exportToPDF() {
            const printContent = document.getElementById('print-content');
            const printScore = document.getElementById('print-score');
            const printTitle = document.getElementById('print-title');
            
            printTitle.textContent = `รายงานผลการทดสอบ - ชุดที่ ${currentPartIndexForPrint}`;
            printScore.innerHTML = `คะแนนรวม: <b>${score} / ${currentPartQuestions.length}</b>`;
            
            let html = `<table class="report-table">
                <thead>
                    <tr>
                        <th style="width: 5%">ข้อ</th>
                        <th style="width: 40%">โจทย์</th>
                        <th style="width: 20%">คำตอบของคุณ</th>
                        <th style="width: 20%">เฉลย</th>
                        <th style="width: 15%">ผลลัพธ์</th>
                    </tr>
                </thead>
                <tbody>`;
            
            answersLog.forEach(log => {
                html += `<tr>
                    <td>${log.no}</td>
                    <td>${log.question}</td>
                    <td>${log.userAnswer}</td>
                    <td>${log.correctAnswer}</td>
                    <td class="${log.isCorrect ? 'status-correct' : 'status-wrong'}">
                        ${log.isCorrect ? 'ถูกต้อง' : 'ผิด'}
                    </td>
                </tr>`;
            });
            
            html += `</tbody></table>`;
            printContent.innerHTML = html;
            
            // สั่งพิมพ์
            window.print();
        }

        // แสดงรีวิว (เฉพาะข้อผิด)
        function showReview() {
            const wrongAnswers = answersLog.filter(log => !log.isCorrect);
            reviewContainer.innerHTML = '<h3>ข้อที่ตอบผิด</h3>';
            reviewContainer.style.display = 'block';
            reviewButton.style.display = 'none';

            wrongAnswers.forEach(item => {
                reviewContainer.innerHTML += `
                    <div class="review-item">
                        <h4>ข้อ ${item.no}: ${item.question}</h4>
                        <p><b>ตอบ:</b> <span class="review-wrong">${item.userAnswer}</span> | <b>เฉลย:</b> <span class="review-correct">${item.correctAnswer}</span></p>
                    </div>
                `;
            });
        }

        // สร้างเมนู
        function createMenu() {
            partSelectionContainer = document.getElementById('part-selection-container');
            partSelectionContainer.innerHTML = '';
            const totalParts = Math.ceil(allQuestionsShuffled.length / QUESTIONS_PER_PART);

            for (let i = 0; i < totalParts; i++) {
                const start = i * QUESTIONS_PER_PART;
                const end = (i === totalParts - 1) ? allQuestionsShuffled.length : (i + 1) * QUESTIONS_PER_PART;
                const count = end - start;
                
                const button = document.createElement('button');
                button.className = 'action-btn part-button';
                button.textContent = `ชุดที่ ${i + 1} (ข้อ ${start + 1} - ${end}) - ${count} ข้อ`;
                button.onclick = () => startGame(start, end, i + 1);
                partSelectionContainer.appendChild(button);
            }
        }

        // Init
        function initializeApp() {
            if (appInitialized) return; 
            appInitialized = true; 
            
            menuContainer = document.getElementById('menu-container');
            gameContainer = document.getElementById('game-container');
            partScoreContainer = document.getElementById('part-score-container');
            partSelectionContainer = document.getElementById('part-selection-container');
            partScoreDisplay = document.getElementById('part-score-display');
            backToMenuButton = document.getElementById('back-to-menu-button');
            reviewButton = document.getElementById('review-button');
            reviewContainer = document.getElementById('review-container');
            exportPdfButton = document.getElementById('export-pdf-button'); // ปุ่มใหม่
        
            questionContainer = document.getElementById('question-container');
            answerContainer = document.getElementById('answer-container');
            feedbackEl = document.getElementById('feedback');
            scoreCounterEl = document.getElementById('score-counter');
            submitButton = document.getElementById('submit-button');
            hintButton = document.getElementById('hint-button');
            navButton = document.getElementById('navigation-button');

            if (!menuContainer) return;

            submitButton.onclick = checkAnswer;
            hintButton.onclick = () => showAnswer(false);
            navButton.onclick = navigate;
            backToMenuButton.onclick = () => showView('menu');
            reviewButton.onclick = showReview;
            exportPdfButton.onclick = exportToPDF; // ผูกฟังก์ชัน
            
            answerContainer.addEventListener('keyup', function(event) {
                if (event.key === 'Enter' && !answered && event.target.classList.contains('answer-input')) checkAnswer();
            });
            
            allQuestionsShuffled = [...trainData];
            shuffleArray(allQuestionsShuffled);
            
            createMenu();
            showView('menu');
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
        window.onload = initializeApp;
    </script>
</body>
</html>