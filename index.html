<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมทดสอบขบวนรถไฟ (แบ่งพาส)</title>
    <!-- เพิ่มฟอนต์ภาษาไทยจาก Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Styles --- */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        /* (ใหม่) คอนเทนเนอร์หลักที่สลับหน้าจอ */
        #app-container {
            width: 100%;
            max-width: 600px;
        }
        
        /* (ใหม่) สไตล์หน้าเมนู */
        #menu-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
        }
        
        #menu-container h1 {
            color: #1a3a66;
            margin-bottom: 25px;
        }

        #part-selection-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* (ใหม่) สไตล์ปุ่มเลือกพาส (ใช้สไตล์ .action-btn ร่วม) */
        .part-button {
            background-color: #007bff;
            width: 100%;
            box-sizing: border-box;
        }
        .part-button:hover {
            background-color: #0056b3;
        }

        /* (แก้ไข) หน้าเกม (ซ่อนไว้ตอนเริ่ม) */
        #game-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            padding: 25px;
            text-align: center;
            box-sizing: border-box;
            display: none; /* ซ่อนตอนเริ่มต้น */
        }
        
        /* (ใหม่) หน้าสรุปคะแนน (ซ่อนไว้ตอนเริ่ม) */
        #part-score-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            padding: 25px 30px;
            text-align: center;
            display: none; /* ซ่อนตอนเริ่มต้น */
        }
        
        #part-score-container h2 {
            color: #1a3a66;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        #part-score-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 25px;
        }
        
        #back-to-menu-button {
            background-color: #6c757d;
        }
        #back-to-menu-button:hover {
             background-color: #5a6268;
        }

        /* (ใหม่) สไตล์สำหรับปุ่มรีวิว */
        #review-button {
            background-color: #f0ad4e; /* สีส้ม */
            margin-top: 10px; /* เว้นระยะจากปุ่มกลับ */
            display: none; /* ซ่อนไว้ก่อน */
        }
        #review-button:hover {
            background-color: #ec971f;
        }

        /* (ใหม่) สไตล์สำหรับส่วนรีวิว */
        #review-container {
            margin-top: 20px;
            text-align: left;
            border-top: 2px solid #eee;
            padding-top: 15px;
            display: none; /* ซ่อนไว้ก่อน */
        }
        .review-item {
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .review-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .review-question {
            font-style: italic;
            color: #555;
            font-size: 0.95rem;
            padding-left: 10px;
        }
        .review-answer p {
            margin: 5px 0 5px 10px;
            font-size: 1rem;
        }
        .review-wrong {
            color: #dc3545;
            font-weight: bold;
            background-color: #fff0f0;
            padding: 2px 5px;
            border-radius: 4px;
        }
        .review-correct {
            color: #28a745;
            font-weight: bold;
            background-color: #f0fff4;
            padding: 2px 5px;
            border-radius: 4px;
        }


        /* --- สไตล์อื่นๆ (เหมือนเดิม) --- */
        h1 {
            color: #1a3a66;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        #score-counter {
            font-size: 1rem;
            color: #555;
            margin-bottom: 20px;
            font-weight: 600;
            min-height: 20px;
        }

        #question-container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            min-height: 60px;
            text-align: left;
        }
        
        .question-line {
            font-size: 1.15rem;
            font-weight: 600;
            line-height: 1.5;
            color: #333;
        }
        
        .question-line span {
            font-weight: bold;
            color: #0056b3;
        }
        
        #answer-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .answer-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }
        
        .answer-group label {
            font-size: 1rem;
            font-weight: 600;
            color: #d9534f;
            margin-bottom: 5px;
        }

        .answer-input {
            font-family: 'Sarabun', sans-serif;
            font-size: 1.1rem;
            font-weight: bold;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .answer-input:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .answer-input.correct {
            border-color: #28a745;
            background-color: #f0fff4;
            color: #28a745;
        }
        
        .answer-input.incorrect {
            border-color: #dc3545;
            background-color: #fff0f0;
            color: #dc3545;
        }

        #feedback {
            font-size: 1.15rem;
            font-weight: bold;
            margin-top: 15px;
            min-height: 30px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        #action-button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            font-family: 'Sarabun', sans-serif;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex-grow: 1;
            min-width: 120px;
            box-sizing: border-box;
        }

        #submit-button { background-color: #007bff; }
        #submit-button:hover { background-color: #0056b3; }
        #hint-button { background-color: #f0ad4e; }
        #hint-button:hover { background-color: #ec971f; }
        #navigation-button { background-color: #6c757d; }
        #navigation-button:hover { background-color: #5a6268; }

        @media (max-width: 480px) {
            h1, #part-score-container h2 { font-size: 1.6rem; }
            .question-line { font-size: 1rem; }
            .answer-input { font-size: 1rem; }
            .action-btn {
                font-size: 0.9rem;
                width: 100%;
                flex-grow: 0;
            }
            #action-button-container { flex-direction: column; }
            .part-button { width: 100%; }
        }
    </style>
</head>
<body>

    <!-- (ใหม่) คอนเทนเนอร์หลัก -->
    <div id="app-container">

        <!-- (ใหม่) หน้าเมนู -->
        <div id="menu-container">
            <h1>เลือกชุดข้อสอบ</h1>
            <p style="color: #666; margin-bottom: 20px;">(ข้อสอบถูกคละสายรถไฟในทุกชุด)</p>
            <div id="part-selection-container">
                <!-- ปุ่มเลือกพาสจะถูกสร้างโดย JS -->
            </div>
        </div>

        <!-- (แก้ไข) หน้าเกม (ย้ายเข้ามา) -->
        <div id="game-container">
            <h1>เกมทดสอบขบวนรถไฟ</h1>
            <div id="score-counter">กำลังโหลด...</div>
            <div id="question-container"></div>
            <div id="answer-container"></div>
            <div id="feedback"></div>
            <div id="action-button-container">
                <button id="submit-button" class="action-btn">ส่งคำตอบ</button>
                <button id="hint-button" class="action-btn">ขอดูเฉลย</button>
                <button id="navigation-button" class="action-btn">ข้าม</button>
            </div>
        </div>
        
        <!-- (ใหม่) หน้าสรุปคะแนน -->
        <div id="part-score-container">
            <h2>สรุปคะแนน (ชุดนี้)</h2>
            <div id="part-score-display">คุณทำได้ 0 / 0 คะแนน</div>
            <button id="back-to-menu-button" class="action-btn">กลับไปหน้าหลัก</button>
            
            <!-- (ใหม่) ปุ่มและพื้นที่สำหรับรีวิวข้อที่ผิด -->
            <button id="review-button" class="action-btn">ดูข้อที่ผิด</button>
            <div id="review-container">
                <!-- เนื้อหารีวิวจะถูกสร้างโดย JS -->
            </div>
        </div>

    </div> <!-- จบ #app-container -->


    <!-- --- JavaScript Logic --- -->
    <script>
        // --- ข้อมูลรถไฟทั้งหมด (177 ข้อ) ---
        const trainData = [
            { route: "กรุงเทพอภิวัฒน์ - ชุมทางหาดใหญ่", number: "31 CNR", type: "ด่วนพิเศษ" },
            { route: "ชุมทางหาดใหญ่ - กรุงเทพอภิวัฒน์", number: "32 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - สุไหงโก-ลก", number: "37", type: "ด่วนพิเศษ" },
            { route: "สุไหงโก-ลก - กรุงเทพอภิวัฒน์", number: "38", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - สุราษฎร์ธานี", number: "39", type: "ด่วนพิเศษ" },
            { route: "สุราษฎร์ธานี - กรุงเทพอภิวัฒน์", number: "40", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - สุราษฎร์ธานี", number: "43", type: "ด่วนพิเศษ" },
            { route: "สุราษฎร์ธานี - กรุงเทพอภิวัฒน์", number: "44", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - ปาดังเบซาร์", number: "45", type: "ด่วนพิเศษ" },
            { route: "ปาดังเบซาร์ - กรุงเทพอภิวัฒน์", number: "46", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - ตรัง", number: "83", type: "ด่วน" },
            { route: "ตรัง - กรุงเทพอภิวัฒน์", number: "84", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - นครศรีธรรมราช", number: "85", type: "ด่วน" },
            { route: "นครศรีธรรมราช - กรุงเทพอภิวัฒน์", number: "86", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - กันตัง", number: "167", type: "เร็ว" },
            { route: "กันตัง - กรุงเทพอภิวัฒน์", number: "168", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - ยะลา", number: "169", type: "เร็ว" },
            { route: "ยะลา - กรุงเทพอภิวัฒน์", number: "170", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - สุไหงโก-ลก", number: "171", type: "เร็ว" },
            { route: "สุไหงโก-ลก - กรุงเทพอภิวัฒน์", number: "172", type: "เร็ว" },
            { route: "ธนบุรี - ประจวบคีรีขันธ์", number: "251", type: "ธรรมดา" },
            { route: "ประจวบคีรีขันธ์ - ธนบุรี", number: "252", type: "ธรรมดา" },
            { route: "ธนบุรี - หลังสวน", number: "255", type: "ธรรมดา" },
            { route: "หลังสวน - ธนบุรี", number: "254", type: "ธรรมดา" },
            { route: "ธนบุรี - น้ำตก", number: "257", type: "ธรรมดา" },
            { route: "น้ำตก - ธนบุรี", number: "258", type: "ธรรมดา" },
            { route: "ธนบุรี - น้ำตก", number: "259", type: "ธรรมดา" },
            { route: "น้ำตก - ธนบุรี", number: "260", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - สวนสนประดิพัทธ์", number: "261", type: "ธรรมดา" },
            { route: "สวนสนประดิพัทธ์ - กรุงเทพ (หัวลำโพง)", number: "262", type: "ธรรมดา" },
            { route: "ธนบุรี - ราชบุรี", number: "351", type: "ชานเมือง" },
            { route: "ราชบุรี - ธนบุรี", number: "352", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - บ้านโป่ง", number: "355", type: "ชานเมือง" },
            { route: "บ้านโป่ง - กรุงเทพ (หัวลำโพง)", number: "356", type: "ชานเมือง" },
            { route: "ชุมพร - ชุมทางหาดใหญ่", number: "445", type: "ท้องถิ่น" },
            { route: "ชุมทางหาดใหญ่ - ชุมพร", number: "446", type: "ท้องถิ่น" },
            { route: "สุราษฎร์ธานี - สุไหงโก-ลก", number: "447", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - สุราษฎร์ธานี", number: "448", type: "ท้องถิ่น" },
            { route: "นครศรีธรรมราช - สุไหงโก-ลก", number: "451", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - นครศรีธรรมราช", number: "452", type: "ท้องถิ่น" },
            { route: "ยะลา - สุไหงโก-ลก", number: "453", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - ยะลา", number: "454", type: "ท้องถิ่น" },
            { route: "นครศรีธรรมราช - ยะลา", number: "455", type: "ท้องถิ่น" },
            { route: "ยะลา - นครศรีธรรมราช", number: "456", type: "ท้องถิ่น" },
            { route: "พัทลุง - สุไหงโก-ลก", number: "463", type: "ท้องถิ่น" },
            { route: "สุไหงโก-ลก - พัทลุง", number: "464", type: "ท้องถิ่น" },
            { route: "กาญจนบุรี - น้ำตก", number: "485", type: "ท้องถิ่น" },
            { route: "น้ำตก - กาญจนบุรี", number: "486", type: "ท้องถิ่น" },
            { route: "สุราษฎร์ธานี - คีรีรัฐนิคม", number: "489", type: "ท้องถิ่น" },
            { route: "คีรีรัฐนิคม - สุราษฎร์ธานี", number: "490", type: "ท้องถิ่น" },
            { route: "ชุมทางหาดใหญ่ - ปาดังเบซาร์", number: "947", type: "พิเศษโดยสาร" },
            { route: "ปาดังเบซาร์ - ชุมทางหาดใหญ่", number: "948", type: "พิเศษโดยสาร" },
            { route: "ชุมทางหาดใหญ่ - ปาดังเบซาร์", number: "949", type: "พิเศษโดยสาร" },
            { route: "ปาดังเบซาร์ - ชุมทางหาดใหญ่", number: "950", type: "พิเศษโดยสาร" },
            { route: "ธนบุรี - นครปฐม", number: "1115", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1116", type: "พิเศษชานเมือง" },
            { route: "ธนบุรี - นครปฐม", number: "1117", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1118", type: "พิเศษชานเมือง" },
            { route: "ธนบุรี - นครปฐม", number: "1123", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1124", type: "พิเศษชานเมือง" },
            { route: "ธนบุรี - นครปฐม", number: "1129", type: "พิเศษชานเมือง" },
            { route: "นครปฐม - ธนบุรี", number: "1132", type: "พิเศษชานเมือง" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "7", type: "ด่วนพิเศษ" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "8", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "9 CNR", type: "ด่วนพิเศษ" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "10 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "13", type: "ด่วนพิเศษ" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "14", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "51", type: "ด่วน" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "52", type: "ด่วน" },
            { route: "เชียงใหม่ - กรุงเทพอภิวัฒน์", number: "102", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - เด่นชัย", number: "107", type: "เร็ว" },
            { route: "เด่นชัย - กรุงเทพอภิวัฒน์", number: "108", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - เชียงใหม่", number: "109", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - เด่นชัย", number: "111", type: "เร็ว" },
            { route: "เด่นชัย - กรุงเทพอภิวัฒน์", number: "112", type: "เร็ว" },
            { route: "กรุงเทพ (หัวลำโพง) - พิษณุโลก", number: "201", type: "ธรรมดา" },
            { route: "พิษณุโลก - กรุงเทพ (หัวลำโพง)", number: "202", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - นครสวรรค์", number: "207", type: "ธรรมดา" },
            { route: "นครสวรรค์ - กรุงเทพ (หัวลำโพง)", number: "208", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - บ้านตาคลี", number: "209", type: "ธรรมดา" },
            { route: "บ้านตาคลี - กรุงเทพ (หัวลำโพง)", number: "210", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ตะพานหิน", number: "211", type: "ธรรมดา" },
            { route: "ตะพานหิน - กรุงเทพ (หัวลำโพง)", number: "212", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ลพบุรี", number: "301", type: "ชานเมือง" },
            { route: "ลพบุรี - กรุงเทพ (หัวลำโพง)", number: "302", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ลพบุรี", number: "303", type: "ชานเมือง" },
            { route: "ลพบุรี - กรุงเทพ (หัวลำโพง)", number: "304", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางบ้านภาชี", number: "313", type: "ชานเมือง" },
            { route: "ชุมทางบ้านภาชี - กรุงเทพ (หัวลำโพง)", number: "314", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ลพบุรี", number: "317", type: "ชานเมือง" },
            { route: "ลพบุรี - กรุงเทพ (หัวลำโพง)", number: "318", type: "ชานเมือง" },
            { route: "ลพบุรี - พิษณุโลก", number: "401", type: "ท้องถิ่น" },
            { route: "พิษณุโลก - ลพบุรี", number: "402", type: "ท้องถิ่น" },
            { route: "พิษณุโลก - ศิลาอาสน์", number: "403", type: "ท้องถิ่น" },
            { route: "นครสวรรค์ - เชียงใหม่", number: "407", type: "ท้องถิ่น" },
            { route: "เชียงใหม่ - นครสวรรค์", number: "408", type: "ท้องถิ่น" },
            { route: "ศิลาอาสน์ - พิษณุโลก", number: "410", type: "ท้องถิ่น" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "21", type: "ด่วนพิเศษ" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "22", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "23 CNR", type: "ด่วนพิเศษ" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "24 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - หนองคาย", number: "25 CNR", type: "ด่วนพิเศษ" },
            { route: "หนองคาย - กรุงเทพอภิวัฒน์", number: "26 CNR", type: "ด่วนพิเศษ" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "71", type: "ด่วน" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "72", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - หนองคาย", number: "75", type: "ด่วน" },
            { route: "หนองคาย - กรุงเทพอภิวัฒน์", number: "76", type: "ด่วน" },
            { route: "กรุงเทพอภิวัฒน์ - เวียงจันทน์ (คำสะหวาด)", number: "133", type: "เร็ว" },
            { route: "เวียงจันทน์ (คำสะหวาด) - กรุงเทพอภิวัฒน์", number: "134", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "135", type: "เร็ว" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "136", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "139", type: "เร็ว" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "140", type: "เร็ว" },
            { route: "กรุงเทพอภิวัฒน์ - อุบลราชธานี", number: "141", type: "เร็ว" },
            { route: "อุบลราชธานี - กรุงเทพอภิวัฒน์", number: "142", type: "เร็ว" },
            { route: "หนองคาย - เวียงจันทน์ (คำสะหวาด)", number: "147", type: "เร็ว" },
            { route: "เวียงจันทน์ (คำสะหวาด) - หนองคาย", number: "148", type: "เร็ว" },
            { route: "กรุงเทพ (หัวลำโพง) - สุรินทร์", number: "233", type: "ธรรมดา" },
            { route: "สุรินทร์ - กรุงเทพ (หัวลำโพง)", number: "234", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางแก่งคอย", number: "339", type: "ชานเมือง" },
            { route: "ชุมทางแก่งคอย - กรุงเทพ (หัวลำโพง)", number: "340", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางแก่งคอย", number: "341", type: "ชานเมือง" },
            { route: "ชุมทางแก่งคอย - กรุงเทพ (หัวลำโพง)", number: "342", type: "ชานเมือง" },
            { route: "นครราชสีมา - หนองคาย", number: "415", type: "ท้องถิ่น" },
            { route: "อุดรธานี - นครราชสีมา", number: "416", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุดรธานี", number: "417", type: "ท้องถิ่น" },
            { route: "หนองคาย - นครราชสีมา", number: "418", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุบลราชธานี", number: "419", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - ลำชี", number: "420", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุบลราชธานี", number: "421", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - ลำชี", number: "422", type: "ท้องถิ่น" },
            { route: "ลำชี - สำโรงทาบ", number: "423", type: "ท้องถิ่น" },
            { route: "สำโรงทาบ - นครราชสีมา", number: "424", type: "ท้องถิ่น" },
            { route: "ลำชี - อุบลราชธานี", number: "425", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - นครราชสีมา", number: "426", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - อุบลราชธานี", number: "427", type: "ท้องถิ่น" },
            { route: "อุบลราชธานี - นครราชสีมา", number: "428", type: "ท้องถิ่น" },
            { route: "นครราชสีมา - ชุมทางบัวใหญ่", number: "429", type: "ท้องถิ่น" },
            { route: "ชุมทางบัวใหญ่ - นครราชสีมา", number: "430", type: "ท้องถิ่น" },
            { route: "ชุมทางแก่งคอย - ขอนแก่น", number: "431", type: "ท้องถิ่น" },
            { route: "ขอนแก่น - ชุมทางแก่งคอย", number: "432", type: "ท้องถิ่น" },
            { route: "ชุมทางแก่งคอย - ชุมทางบัวใหญ่", number: "433", type: "ท้องถิ่น" },
            { route: "ชุมทางบัวใหญ่ - ชุมทางแก่งคอย", number: "434", type: "ท้องถิ่น" },
            { route: "ชุมทางแก่งคอย - ชุมทางบัวใหญ่", number: "439", type: "ท้องถิ่น" },
            { route: "ชุมทางบัวใหญ่ - ชุมทางแก่งคอย", number: "440", type: "ท้องถิ่น" },
            { route: "กรุงเทพ (หัวลำโพง) - ด่านพรมแดนบ้านคลองลึก", number: "275", type: "ธรรมดา" },
            { route: "ด่านพรมแดนบ้านคลองลึก - กรุงเทพ (หัวลำโพง)", number: "276", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - กบินทร์บุรี", number: "277", type: "ธรรมดา" },
            { route: "กบินทร์บุรี - กรุงเทพ (หัวลำโพง)", number: "278", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ด่านพรมแดนบ้านคลองลึก", number: "279", type: "ธรรมดา" },
            { route: "ด่านพรมแดนบ้านคลองลึก - กรุงเทพ (หัวลำโพง)", number: "280", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - กบินทร์บุรี", number: "281", type: "ธรรมดา" },
            { route: "กบินทร์บุรี - กรุงเทพ (หัวลำโพง)", number: "282", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - จุกเสม็ด", number: "283", type: "ธรรมดา" },
            { route: "จุกเสม็ด - กรุงเทพ (หัวลำโพง)", number: "284", type: "ธรรมดา" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "367", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "368", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ปราจีนบุรี", number: "371", type: "ชานเมือง" },
            { route: "ปราจีนบุรี - กรุงเทพ (หัวลำโพง)", number: "372", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "379", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "380", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "383", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "384", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "388", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "389", type: "ชานเมือง" },
            { route: "ชุมทางฉะเชิงเทรา - กรุงเทพ (หัวลำโพง)", number: "390", type: "ชานเมือง" },
            { route: "กรุงเทพ (หัวลำโพง) - ชุมทางฉะเชิงเทรา", number: "391", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4302", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4303", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4304", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4305", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4306", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4307", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4308", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4309", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4310", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4311", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4312", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4313", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4314", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4315", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4316", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4317", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4320", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4321", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4322", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4323", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4324", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4325", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4326", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4327", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4328", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4329", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4340", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4341", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4342", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4343", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4344", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4345", type: "ชานเมือง" },
            { route: "มหาชัย - วงเวียนใหญ่", number: "4346", type: "ชานเมือง" },
            { route: "วงเวียนใหญ่ - มหาชัย", number: "4347", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4380", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4381", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4382", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4383", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4384", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4385", type: "ชานเมือง" },
            { route: "แม่กลอง - บ้านแหลม", number: "4386", type: "ชานเมือง" },
            { route: "บ้านแหลม - แม่กลอง", number: "4387", type: "ชานเมือง" }
        ];

        // --- (ใหม่) ตรรกะของเกมที่แบ่งพาส ---
        
        // (ใหม่) ค่าคงที่สำหรับแบ่งพาส
        const QUESTIONS_PER_PART = 25;

        // (ใหม่) ตัวแปรสำหรับเก็บคำถามเฉพาะพาสนี้
        let currentPartQuestions = [];
        let allQuestionsShuffled = []; // (ใหม่) เก็บข้อมูลทั้งหมดที่สลับแล้ว
        
        let currentQuestionIndex = 0;
        let currentTemplate = 0; // 0:FindNum, 1:FindType, 2:FindRoute
        let score = 0;
        let answered = false;
        let allQuestionsAnswered = false; // (แก้ไข) ใช้สำหรับเช็คว่าจบ "พาส" นี้หรือยัง
        let incorrectAnswersForReview = []; // (ใหม่) สำหรับเก็บข้อที่ผิด

        // (ใหม่) ดึง Element ของหน้าจอต่างๆ
        let menuContainer, gameContainer, partScoreContainer, partSelectionContainer,
            partScoreDisplay, backToMenuButton, reviewButton, reviewContainer,
            questionContainer, answerContainer, feedbackEl, scoreCounterEl,
            submitButton, hintButton, navButton;
            
        let appInitialized = false; // (ใหม่) Flag to prevent double init

        // (ใหม่) Function สลับหน้าจอ
        function showView(viewName) {
            if (!menuContainer || !gameContainer || !partScoreContainer) {
                console.error("showView called before elements are initialized");
                return;
            }
            menuContainer.style.display = 'none';
            gameContainer.style.display = 'none';
            partScoreContainer.style.display = 'none';

            if (viewName === 'menu') {
                menuContainer.style.display = 'block';
            } else if (viewName === 'game') {
                gameContainer.style.display = 'block';
            } else if (viewName === 'score') {
                partScoreContainer.style.display = 'block';
            }
        }

        // Function สับเปลี่ยนอาร์เรย์
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Functions สำหรับเทียบคำตอบ (เหมือนเดิม)
        function normalizeText(str) {
            if (typeof str !== 'string') return '';
            return str.trim().toUpperCase()
                      .replace(/\s/g, '') 
                      .replace(/\(.*\)/g, '');
        }
        function normalizeNumber(str) {
            if (typeof str !== 'string') return '';
            return str.trim().toUpperCase().replace(/\s/g, ''); 
        }

        // Function สร้าง HTML (เหมือนเดิม)
        function createInput(id, label) {
            return `
                <div class="answer-group">
                    <label for="input-${id}">${label}:</label>
                    <input type="text" id="input-${id}" class="answer-input" placeholder="เติมคำตอบ...">
                </div>
            `;
        }
        function createQuestionLine(label, value) {
            return `<div class="question-line">${label}: <span>${value}</span></div>`;
        }
        
        // (แก้ไข) Function อัปเดตตัวนับ (ใช้ currentPartQuestions)
        function updateCounters() {
            const remaining = currentPartQuestions.filter(q => q.status === 'unanswered').length;
            const totalInPart = currentPartQuestions.length;
            scoreCounterEl.textContent = `ข้อที่: ${currentQuestionIndex + 1}/${totalInPart} | คะแนน: ${score} | เหลือ: ${remaining}`;
        }

        // (แก้ไข) Function แสดงคำถาม (ใช้ currentPartQuestions)
        function displayQuestion() {
            answered = false;
            allQuestionsAnswered = false;
            
            currentTemplate = Math.floor(Math.random() * 3); 
            const q = currentPartQuestions[currentQuestionIndex];
            
            questionContainer.innerHTML = '';
            answerContainer.innerHTML = '';
            feedbackEl.textContent = '';
            
            switch (currentTemplate) {
                case 0: // โจทย์: เส้นทาง + ประเภท -> ตอบ: หมายเลข
                    questionContainer.innerHTML = createQuestionLine('เส้นทาง', q.route) + createQuestionLine('ประเภท', q.type);
                    answerContainer.innerHTML = createInput('number', 'หมายเลขขบวนคือ');
                    break;
                case 1: // โจทย์: หมายเลข + เส้นทาง -> ตอบ: ประเภท
                    questionContainer.innerHTML = createQuestionLine('หมายเลข', q.number) + createQuestionLine('เส้นทาง', q.route);
                    answerContainer.innerHTML = createInput('type', 'ประเภทรถคือ');
                    break;
                case 2: // โจทย์: หมายเลข + ประเภท -> ตอบ: เส้นทาง
                    questionContainer.innerHTML = createQuestionLine('หมายเลข', q.number) + createQuestionLine('ประเภท', q.type);
                    answerContainer.innerHTML = createInput('route', 'เส้นทางคือ (ต้นทาง - ปลายทาง)');
                    break;
            }

            submitButton.style.display = 'inline-block';
            hintButton.style.display = 'inline-block';
            navButton.style.display = 'inline-block';
            navButton.textContent = 'ข้าม';
            
            updateCounters();
            
            // (ย้าย) ย้าย listener มาที่นี่
            document.querySelectorAll('.answer-input').forEach(input => {
                input.onkeyup = function(event) {
                    if (event.key === 'Enter' && !answered) {
                        checkAnswer();
                    }
                }; 
            });
        }
        
        // (แก้ไข) Function ตรวจคำตอบ (ใช้ currentPartQuestions)
        function checkAnswer() {
            if (answered) return;
            
            const q = currentPartQuestions[currentQuestionIndex];
            let isFullyCorrect = true; 
            let correctAnswersForHint = []; 

            if (currentTemplate === 0) { 
                const inputEl = document.getElementById('input-number');
                const userInputNorm = normalizeNumber(inputEl.value); 
                
                const normRoute = normalizeText(q.route);
                const normType = normalizeText(q.type);
                const allMatches = trainData.filter(item => 
                    normalizeText(item.route) === normRoute && 
                    normalizeText(item.type) === normType
                );
                
                const acceptableNumbers = allMatches.map(item => item.number);
                correctAnswersForHint = acceptableNumbers; 
                
                const acceptableNumbersNorm = [...new Set(
                    acceptableNumbers.flatMap(n => [normalizeNumber(n), normalizeNumber(n.replace('CNR', ''))])
                )];
                
                if (acceptableNumbersNorm.includes(userInputNorm) && userInputNorm !== "") {
                    inputEl.classList.add('correct');
                } else {
                    inputEl.classList.add('incorrect');
                    isFullyCorrect = false;
                }
                inputEl.disabled = true;

            } else if (currentTemplate === 1) { 
                const inputEl = document.getElementById('input-type');
                const userInputNorm = normalizeText(inputEl.value); 
                const correctNorm = normalizeText(q.type);
                correctAnswersForHint.push(q.type); 

                if (userInputNorm === correctNorm && userInputNorm !== "") {
                    inputEl.classList.add('correct');
                } else {
                    inputEl.classList.add('incorrect');
                    isFullyCorrect = false;
                }
                inputEl.disabled = true;

            } else if (currentTemplate === 2) { 
                const inputEl = document.getElementById('input-route');
                const userInputNorm = normalizeText(inputEl.value); 
                const correctNorm = normalizeText(q.route);
                correctAnswersForHint.push(q.route); 

                if (userInputNorm === correctNorm && userInputNorm !== "") {
                    inputEl.classList.add('correct');
                } else {
                    inputEl.classList.add('incorrect');
                    isFullyCorrect = false;
                }
                inputEl.disabled = true;
            }

            answered = true;
            submitButton.style.display = 'none';
            hintButton.style.display = 'none';
            navButton.textContent = 'ข้อถัดไป';

            if (isFullyCorrect) {
                feedbackEl.textContent = 'ถูกต้อง!';
                feedbackEl.style.color = '#28a745';
                if (currentPartQuestions[currentQuestionIndex].status === 'unanswered') {
                    score++;
                }
                currentPartQuestions[currentQuestionIndex].status = 'correct';
            } else {
                feedbackEl.textContent = `ผิด! คำตอบคือ: ${correctAnswersForHint.join(' / ')}`;
                feedbackEl.style.color = '#dc3545';
                currentPartQuestions[currentQuestionIndex].status = 'incorrect';
                
                // (ใหม่) เก็บข้อมูลข้อที่ผิด
                saveIncorrectAnswer(q, correctAnswersForHint);
                
                showAnswer(true, correctAnswersForHint);
            }
            
            updateCounters();
        }
        
        // (แก้ไข) Function ดูเฉลย (ใช้ currentPartQuestions)
        function showAnswer(onlyIncorrect = false, correctAnswers = []) {
            if (answered && !onlyIncorrect) return;
            
            const q = currentPartQuestions[currentQuestionIndex];
            
            if (correctAnswers.length === 0) {
                 if (currentTemplate === 0) {
                    const normRoute = normalizeText(q.route);
                    const normType = normalizeText(q.type);
                    const allMatches = trainData.filter(item => normalizeText(item.route) === normRoute && normalizeText(item.type) === normType);
                    correctAnswers = allMatches.map(item => item.number);
                 } else if (currentTemplate === 1) {
                    correctAnswers = [q.type];
                 } else if (currentTemplate === 2) {
                    correctAnswers = [q.route];
                 }
            }
            
            const answerString = correctAnswers.join(' / ');

            if (currentTemplate === 0) {
                const el = document.getElementById('input-number');
                if (!onlyIncorrect || el.classList.contains('incorrect')) { el.value = answerString; el.classList.add('correct'); el.classList.remove('incorrect'); }
                el.disabled = true;
            } else if (currentTemplate === 1) {
                const el = document.getElementById('input-type');
                if (!onlyIncorrect || el.classList.contains('incorrect')) { el.value = answerString; el.classList.add('correct'); el.classList.remove('incorrect'); }
                el.disabled = true;
            } else if (currentTemplate === 2) {
                const el = document.getElementById('input-route');
                if (!onlyIncorrect || el.classList.contains('incorrect')) { el.value = answerString; el.classList.add('correct'); el.classList.remove('incorrect'); }
                el.disabled = true;
            }
            
            if (!onlyIncorrect) { 
                answered = true;
                feedbackEl.textContent = `เฉลยคือ: ${answerString}`;
                feedbackEl.style.color = '#f0ad4e';
                currentPartQuestions[currentQuestionIndex].status = 'incorrect';
                
                // (ใหม่) เก็บข้อมูลข้อที่ผิด (กรณี_กดดูเฉลย)
                saveIncorrectAnswer(q, correctAnswers, true);

                submitButton.style.display = 'none';
                hintButton.style.display = 'none';
                navButton.textContent = 'ข้อถัดไป';
                updateCounters();
            }
        }
        
        // (ใหม่) Function แสดงคะแนนของพาส
        function showPartScore() {
            allQuestionsAnswered = true; // ตั้งค่าสถานะว่าจบพาสนี้แล้ว
            showView('score'); // สลับไปหน้าสรุปคะแนน
            
            const totalInPart = currentPartQuestions.length;
            partScoreDisplay.textContent = `คุณทำได้ ${score} / ${totalInPart} คะแนน`;
            
            // (ใหม่) ตรวจสอบว่ามีข้อผิดหรือไม่
            reviewContainer.innerHTML = ''; // ล้างรีวิวเก่า (ถ้ามี)
            reviewContainer.style.display = 'none'; // ซ่อนคอนเทนเนอร์รีวิว
            
            if (incorrectAnswersForReview.length > 0) {
                reviewButton.style.display = 'inline-block'; // แสดงปุ่มรีวิว
            } else {
                reviewButton.style.display = 'none'; // ซ่อนปุ่มรีวิว (ถ้าถูกหมด)
            }
        }

        // (แก้ไข) Function สำหรับปุ่ม ข้าม / ข้อถัดไป (ในพาส)
        function navigate() {
            let nextIndex = -1;
            // 1. ค้นหาในพาสปัจจุบัน (จากข้อปัจจุบัน + 1 ไปจนจบพาส)
            for (let i = currentQuestionIndex + 1; i < currentPartQuestions.length; i++) {
                if (currentPartQuestions[i].status === 'unanswered') {
                    nextIndex = i;
                    break;
                }
            }
            // 2. ถ้าไม่เจอ ให้วนกลับมาค้นหาตั้งแต่ข้อ 0 (ในพาสนี้)
            if (nextIndex === -1) {
                for (let i = 0; i < currentQuestionIndex; i++) {
                    if (currentPartQuestions[i].status === 'unanswered') {
                        nextIndex = i;
                        break;
                    }
                }
            }
            
            // 3. จัดการผลลัพธ์
            if (nextIndex !== -1) {
                // เจอข้อที่ยังไม่ตอบ
                currentQuestionIndex = nextIndex;
                displayQuestion();
            } else {
                // ไม่เจอข้อที่ยังไม่ตอบ
                // ตรวจสอบว่าข้อปัจจุบัน (ข้อสุดท้ายที่เหลือ) ตอบหรือยัง
                if (currentPartQuestions[currentQuestionIndex].status === 'unanswered') {
                    if (answered) { // ถ้าตอบแล้ว (เช่น กดดูเฉลยข้อสุดท้าย)
                        showPartScore();
                    }
                    // ถ้ายังไม่ตอบ ก็ไม่ต้องทำอะไร (รอผู้ใช้กด submit)
                } else {
                    // ตอบครบทุกข้อแล้ว
                    showPartScore();
                }
            }
        }
        
        // (ใหม่) Function สร้างหน้าเมนู
        function createMenu() {
            partSelectionContainer.innerHTML = ''; // เคลียร์ปุ่มเก่า (ถ้ามี)
            const totalParts = Math.ceil(allQuestionsShuffled.length / QUESTIONS_PER_PART); // = 7

            for (let i = 0; i < totalParts; i++) {
                const start = i * QUESTIONS_PER_PART;
                // ใช้ allQuestionsShuffled แทน trainData
                const end = (i === totalParts - 1) ? allQuestionsShuffled.length : (i + 1) * QUESTIONS_PER_PART;
                const count = end - start;
                
                const button = document.createElement('button');
                button.className = 'action-btn part-button'; // ใช้สไตล์เดียวกัน
                button.textContent = `ชุดที่ ${i + 1} (ข้อ ${start + 1} - ${end}) - ${count} ข้อ`;
                
                // (แก้ไข) ส่ง start และ end ไปให้ startGame
                button.onclick = () => startGame(start, end); 
                
                partSelectionContainer.appendChild(button);
            }
        }
        
        // (ใหม่) Function เริ่มเกม (รับ start/end)
        function startGame(start, end) {
            showView('game'); // สลับไปหน้าเกม
            
            // 1. ตัดข้อมูลเฉพาะพาสนี้ (จากข้อมูลที่สลับแล้ว)
            const partData = allQuestionsShuffled.slice(start, end);
            
            // 2. เตรียมข้อมูล (ไม่ต้องสลับซ้ำก็ได้ เพราะสลับมาแล้ว แต่สลับอีกทีในพาสก็ดี)
            currentPartQuestions = [...partData];
            // shuffleArray(currentPartQuestions); // ไม่ต้องสลับในพาสอีกก็ได้ ถ้าอยากให้ลำดับคงที่ตามที่สุ่มมาตอนแรก
            // หรือจะสลับอีกทีเพื่อให้ภายในพาสสุ่มใหม่ทุกครั้งที่เข้าก็ได้
            // แต่เพื่อความง่าย ให้คงลำดับไว้ตาม Global Shuffle
            currentPartQuestions.forEach(q => q.status = 'unanswered');
            
            // 3. รีเซ็ตค่าสำหรับพาสนี้
            currentQuestionIndex = 0;
            score = 0;
            allQuestionsAnswered = false;
            incorrectAnswersForReview = []; // (ใหม่) ล้างรายการข้อผิดของพาสเก่า
            reviewButton.style.display = 'none'; // (ใหม่) ซ่อนปุ่มรีวิว
            reviewContainer.style.display = 'none'; // (ใหม่) ซ่อนรีวิวเก่า
            
            // 4. แสดงคำถามข้อแรก
            displayQuestion();
        }

        // (ใหม่) Function สร้างข้อความโจทย์สำหรับรีวิว
        function getQuestionLinesForReview(item) {
            let lines = '';
            const q = item.questionData;
            switch (item.template) {
                case 0: // ตอบ Number
                    lines = createQuestionLine('เส้นทาง', q.route) + createQuestionLine('ประเภท', q.type);
                    break;
                case 1: // ตอบ Type
                    lines = createQuestionLine('หมายเลข', q.number) + createQuestionLine('เส้นทาง', q.route);
                    break;
                case 2: // ตอบ Route
                    lines = createQuestionLine('หมายเลข', q.number) + createQuestionLine('ประเภท', q.type);
                    break;
            }
            // (แก้ไข) ต้องลบ <span> ออกจาก HTML ที่สร้าง
            return lines.replace(/<span[^>]*>/g, ' ').replace(/<\/span>/g, '');
        }

        // (ใหม่) Function เก็บข้อมูลข้อที่ผิด
        function saveIncorrectAnswer(q, correctAnswers, userSkipped = false) {
            let userAnswers = [];
            
            if (userSkipped) {
                userAnswers.push("(กดดูเฉลย)");
            } else {
                // ดึงคำตอบที่ผู้ใช้พิมพ์
                if (currentTemplate === 0) {
                    userAnswers.push(document.getElementById('input-number').value || "(ว่าง)");
                } else if (currentTemplate === 1) {
                    userAnswers.push(document.getElementById('input-type').value || "(ว่าง)");
                } else if (currentTemplate === 2) {
                    userAnswers.push(document.getElementById('input-route').value || "(ว่าง)");
                }
            }

            incorrectAnswersForReview.push({
                questionData: q,
                template: currentTemplate,
                userAnswers: userAnswers,
                correctAnswers: correctAnswers
            });
        }
        
        // (ใหม่) Function แสดงรีวิวข้อที่ผิด
        function showReview() {
            reviewContainer.innerHTML = '<h3>ข้อที่ตอบผิด</h3>';
            reviewContainer.style.display = 'block';
            reviewButton.style.display = 'none'; // ซ่อนปุ่มหลังจากคลิก

            incorrectAnswersForReview.forEach(item => {
                const questionHtml = getQuestionLinesForReview(item).replace(/<\/div>/g, '</div><br>'); // เพิ่ม <br>
                const userAns = item.userAnswers.join(', ');
                const correctAns = item.correctAnswers.join(' / ');

                const reviewHtml = `
                    <div class="review-item">
                        <h4>โจทย์:</h4>
                        <div class="review-question">${questionHtml}</div>
                        <div class="review-answer">
                            <p><b>คำตอบของคุณ:</b> <span class="review-wrong">${userAns}</span></p>
                            <p><b>คำตอบที่ถูก:</b> <span class="review-correct">${correctAns}</span></p>
                        </div>
                    </div>
                `;
                reviewContainer.innerHTML += reviewHtml;
            });
        }

        // (ใหม่) Function ที่จะเริ่มทุกอย่าง
        function initializeApp() {
            if (appInitialized) return; 
            appInitialized = true; 
            
            // **กำหนดค่า** Element 
            menuContainer = document.getElementById('menu-container');
            gameContainer = document.getElementById('game-container');
            partScoreContainer = document.getElementById('part-score-container');
            partSelectionContainer = document.getElementById('part-selection-container');
            partScoreDisplay = document.getElementById('part-score-display');
            backToMenuButton = document.getElementById('back-to-menu-button');
            reviewButton = document.getElementById('review-button');
            reviewContainer = document.getElementById('review-container');
        
            questionContainer = document.getElementById('question-container');
            answerContainer = document.getElementById('answer-container');
            feedbackEl = document.getElementById('feedback');
            scoreCounterEl = document.getElementById('score-counter');
            submitButton = document.getElementById('submit-button');
            hintButton = document.getElementById('hint-button');
            navButton = document.getElementById('navigation-button');

            if (!menuContainer || !gameContainer || !partScoreContainer) {
                console.error('Critical view elements not found!');
                return;
            }

            // ตั้งค่า listener
            submitButton.onclick = checkAnswer;
            hintButton.onclick = () => showAnswer(false, []);
            navButton.onclick = navigate;
            backToMenuButton.onclick = () => showView('menu');
            reviewButton.onclick = showReview;
            
            answerContainer.addEventListener('keyup', function(event) {
                if (event.key === 'Enter' && !answered) {
                    if (event.target && event.target.classList.contains('answer-input')) {
                        checkAnswer();
                    }
                }
            });
            
            // (ใหม่) สลับข้อมูลทั้งหมดก่อนสร้างเมนู
            allQuestionsShuffled = [...trainData];
            shuffleArray(allQuestionsShuffled);
            
            // เริ่มต้น
            createMenu();
            showView('menu');
        }

        // (แก้ไข) ตั้งค่าทุกอย่างหลังจาก DOM โหลดเสร็จ
        document.addEventListener('DOMContentLoaded', initializeApp);
        window.onload = initializeApp; // Fallback
    </script>
</body>
</html>